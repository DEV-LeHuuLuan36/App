@model App.ViewModels.HoaDonViewModel

@{
    ViewData["Title"] = "Chi tiết Hóa đơn: " + Model.HoaDon.MaHoaDon;
    bool daThanhToan = Model.HoaDon.TrangThai == "Đã thanh toán";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">@ViewData["Title"]</h6>
        @if (!daThanhToan)
        {
            <a asp-action="ThanhToan" asp-route-id="@Model.HoaDon.MaHoaDon" class="btn btn-success">
                <i class="fas fa-check-circle"></i> Tiến hành Thanh toán
            </a>
        }
    </div>
    <div class="card-body">
        <dl class="row">
            <dt class="col-sm-3">Bệnh nhân</dt>
            <dd class="col-sm-9">@Model.HoaDon.MaBenhNhanNavigation.HoTenBenhNhan</dd>
            <dt class="col-sm-3">Nhân viên lập</dt>
            <dd class="col-sm-9">@Model.HoaDon.MaNhanVienNavigation?.HoTen</dd>
            <dt class="col-sm-3">Trạng thái</dt>
            <dd class="col-sm-9">
                @if (daThanhToan)
                {
                    <span class="badge bg-success fs-6">@Model.HoaDon.TrangThai</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark fs-6">@Model.HoaDon.TrangThai</span>
                }
            </dd>
            <dt class="col-sm-3">Tổng tiền</dt>
            <dd class="col-sm-9 fs-4 fw-bold text-danger">@Model.HoaDon.TongTien.Value.ToString("N0") VNĐ</dd>
        </dl>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Chi tiết Dịch vụ & Thuốc</h6>
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nội dung</th>
                    <th>Loại</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.ChiTietHoaDon)
                {
                    <tr>
                        <td>
                            @if (item.Loai == "Dịch vụ")
                            {
                                <strong>@item.MaDichVuNavigation?.TenDichVu</strong>
                            }
                            else
                            {
                                <strong>Đơn thuốc: @item.MaDonThuoc</strong>
                            }
                        </td>
                        <td>@item.Loai</td>
                        <td>@item.SoLuong</td>
                        <td>@item.DonGia.Value.ToString("N0")</td>
                        <td>@item.ThanhTien.Value.ToString("N0")</td>
                    </tr>
                }
                @if (!Model.ChiTietHoaDon.Any())
                {
                    <tr><td colspan="5" class="text-center">Hóa đơn trống.</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (!daThanhToan)
{
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Thêm Dịch vụ</h6>
                </div>
                <div class="card-body">
                    <form asp-action="ThemDichVu" method="post">
                        <input type="hidden" name="MaHoaDon" value="@Model.HoaDon.MaHoaDon" />
                        <div class="mb-3">
                            <label>Chọn Dịch vụ</label>
                            <select name="MaDichVu" class="form-control" asp-items="ViewBag.DichVuList">
                                <option value="">-- Chọn --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Số lượng</label>
                            <input type="number" name="SoLuong" class="form-control" value="1" min="1" />
                        </div>
                        <button type="submit" class="btn btn-primary">Thêm</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Thêm Đơn thuốc (Chưa thanh toán)</h6>
                </div>
                <div class="card-body">
                    <form asp-action="ThemThuoc" method="post">
                        <input type="hidden" name="MaHoaDon" value="@Model.HoaDon.MaHoaDon" />
                        <div class="mb-3">
                            <label>Chọn Đơn thuốc</label>
                            <select name="MaDonThuoc" class="form-control" asp-items="ViewBag.DonThuocList">
                                <option value="">-- Chọn --</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Thêm</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}